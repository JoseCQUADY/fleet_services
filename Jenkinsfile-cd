pipeline {
    agent any

    environment {
        REMOTE_IP = '40.233.6.181'               // Cambia esto por la IP real de tu servidor
        DOCKER_USER = 'jcq12'                        // Usuario Docker Hub
        IMAGE_TAG = 'latest'                         // O usa alguna variable/tag dinámico
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Obtener servicios modificados') {
            steps {
                copyArtifacts(
                    projectName: 'fleet-system/development',
                    filter: 'changed_services.txt',
                    selector: specific('development')
                )
            }
        }

        stage('Desplegar servicios modificados') {
            steps {
                bat '''
                    @echo off
                    setlocal enabledelayedexpansion

                    if not exist changed_services.txt (
                        echo No hay servicios modificados.
                        exit /b 0
                    )

                    for /f %%S in (changed_services.txt) do (
                        call :deployService %%S
                    )

                    exit /b 0

:deployService
                    set SERVICE=%1

                    if "%SERVICE%"=="ms-api-gateway" (
                        set CONTAINER=gateway
                        set PORT=8080
                    ) else if "%SERVICE%"=="ms-auth-service" (
                        set CONTAINER=auth
                        set PORT=8081
                    ) else if "%SERVICE%"=="ms-administrator-service" (
                        set CONTAINER=administrator
                        set PORT=8082
                    ) else if "%SERVICE%"=="ms-invitation-service" (
                        set CONTAINER=code
                        set PORT=8083
                    ) else if "%SERVICE%"=="ms-vehicle-service" (
                        set CONTAINER=vehicle
                        set PORT=8084
                    ) else if "%SERVICE%"=="ms-driver-service" (
                        set CONTAINER=driver
                        set PORT=8085
                    ) else if "%SERVICE%"=="ms-route-service" (
                        set CONTAINER=route
                        set PORT=8086
                    ) else (
                        echo Servicio %SERVICE% no reconocido. Saltando...
                        goto :eof
                    )

                    echo ===========================
                    echo Desplegando %SERVICE%
                    echo Contenedor: %CONTAINER%
                    echo Puerto: %PORT%
                    echo ===========================

                    ssh -i key.pem opc@%REMOTE_IP% sudo docker pull %DOCKER_USER%/%SERVICE%:%IMAGE_TAG%

                    ssh -i key.pem opc@%REMOTE_IP% docker ps -a -q -f name=^/%CONTAINER%$ > nul && (
                        echo Contenedor %CONTAINER% existe. Deteniéndolo y eliminándolo...
                        ssh -i key.pem opc@%REMOTE_IP% docker stop %CONTAINER%
                        ssh -i key.pem opc@%REMOTE_IP% docker rm %CONTAINER%
                    ) || (
                        echo Contenedor %CONTAINER% no existe. Continuando...
                    )

                    ssh -i key.pem opc@%REMOTE_IP% docker run -d --name %CONTAINER% --network devops -p %PORT%:%PORT% %DOCKER_USER%/%SERVICE%:%IMAGE_TAG%

                    goto :eof
                '''
            }
        }
    }
}
